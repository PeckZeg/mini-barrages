{"version":3,"sources":["es2015-mini-barrages.js"],"names":[],"mappings":"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","file":"mini-barrages.js","sourcesContent":[";(function(moduleFunc) {if (typeof define === 'function' && define.amd) {define('jquery.fn.miniBarrages', ['jquery','lodash','moment'], moduleFunc);}else {moduleFunc(jQuery, _, moment);}})(function($, _, moment) {\nfunction Barrage(timeline, playTime, text) {\n    this.timeline = timeline;\n    this.playTime = moment.duration(playTime);\n    this.text = text;\n\n    this.$el = $('<p />', { class: 'mini-barrage' })\n                    .data('mini-barrage', this)\n                    .text(this.text);\n}\n\nBarrage.prototype.render = function() {\n    this.$el.appendTo(this.timeline.$el);\n\n    var canvasWidth = this.timeline.$el.width(),\n        canvasHeight = this.timeline.$el.height(),\n        top = Math.min(_.random(0, canvasHeight), canvasHeight - this.$el.height());\n\n    this.$el\n        .width(this.$el.width())\n        .css({\n            top: `${top}px`,\n            left: `${canvasWidth}px`\n        });\n\n    return this.$el;\n};\n\nBarrage.prototype.play = function() {\n    this.$el.animate({\n        left: `-${this.$el.width()}px`\n    }, this.timeline.duration, 'linear');\n};\nfunction Timeline(el, duration, barrages, opts) {\n    var timeline = this;\n\n    this.$el = $(el);\n\n    //  弹幕持续时间（时间线市场）\n    duration = moment.duration(duration);\n    this.duration = +duration ? +duration : +moment.duration('00:01:00');\n\n    //  自动播放\n    this.autoplay = _.get(opts, 'autoplay', false);\n\n    //  循环次数\n    this.loop = _.get(opts, 'loop', 0);\n\n    //  弹幕列表\n    this.barrages = _.chain(barrages).groupBy((barrage) => {\n        return +moment.duration(barrage.playTime);\n    }).mapValues((barrages) => {\n        return _.map(barrages, (barrage) => {\n            return new Barrage(timeline, barrage.playTime, barrage.text);\n        });\n    }).value();\n\n    //  渲染时间间隔\n    this.timeInterval = parseInt(_.get(opts, 'timeInterval'));\n    this.timeInterval = isNaN(this.timeInterval) ? 200 : this.timeInterval;\n\n    if (this.autoplay) this.play();\n\n    // console.log(this)\n}\n\n//  播放弹幕\nTimeline.prototype.play = function(startTime) {\n    this._current = +moment.duration(startTime);\n\n    this._timer = _.delay(() => {\n        if (this._current <= this.duration) {\n            var next = this._current + this.timeInterval;\n\n            this.render(this._current, next < this.duration ? next : this.duration);\n            this._current = next;\n            this.play(this._current);\n        }\n\n        else {\n            this._timer = null;\n            this._current = 0;\n        }\n\n\n        if (this.loop == 0 && !this._timer) {\n            this.play();\n        }\n    }, this.timeInterval);\n};\n\n//  过滤出 begin ~ end 的弹幕\nTimeline.prototype.filter = function(begin, end) {\n  return _.chain(this.barrages).filter(function(barrage, playTime) {\n    playTime = parseInt(playTime);\n    return playTime >= begin && playTime < end;\n  }).flatten().value();\n};\n\n//  渲染时间线\nTimeline.prototype.render = function(begin, end) {\n    var barrages = this.filter(begin, end);\n\n    _.each(barrages, (barrage) => {\n        barrage.render();\n        barrage.play();\n    });\n\n    // console.log(barrages)\n};\n// function getPositions(el) {\n//     var $el = $(this),\n//         pos = $el.position()\n// }\n$.fn.miniBarrages = function(opts) {\n    var duration = _.get(opts, 'duration'),\n        barrages = _.get(opts, 'barrages');\n\n    this.each(function() {\n        var $el = $(this).addClass('mini-barrages-canvas');\n\n        $el.data('mini-barrages', new Timeline(this, duration, barrages, opts));\n    });\n\n    // var timeline = new Timeline();\n};\n});"]}